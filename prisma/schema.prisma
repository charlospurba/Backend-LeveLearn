// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- MODEL USER ---
model User {
  id           Int     @id @default(autoincrement())
  username     String  @unique
  password     String
  name         String
  role         Role
  studentId    String?
  points       Int?    @default(0)
  totalCourses Int?    @default(0)
  badges       Int?    @default(0)

  // --- FITUR STREAK & INTERAKSI ---
  streak          Int                  @default(0)
  lastInteraction DateTime?
  // -----------------------------
  activityLogs    UserActivityLog[]
  adaptiveProfile UserAdaptiveProfile?

  instructorId      String?
  instructorCourses Int?
  image             String?  @default("")
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relasi
  enrolledCourses UserCourse[]
  chapterProgress UserChapter[]
  userBadges      UserBadge[]
  userTrades      UserTrade[]
  userChallenges  UserChallenge[]

  @@map("users")
}

enum Role {
  STUDENT
  INSTRUCTOR
  ADMIN
}

// --- MODEL COURSE & CONTENT ---
model Course {
  id          Int      @id @default(autoincrement())
  code        String
  name        String
  description String   @db.Text
  image       String   @default("")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relasi
  chapters    Chapter[]
  enrollments UserCourse[]
  badges      Badge[]

  @@map("courses")
}

model UserCourse {
  id             Int      @id @default(autoincrement())
  userId         Int
  courseId       Int
  progress       Int      @default(0)
  currentChapter Int      @default(1)
  isCompleted    Boolean  @default(false)
  timeStarted    DateTime @default(now())
  timeFinished   DateTime @default(now())
  enrolledAt     DateTime @default(now())

  // Relasi
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  course Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
  @@map("user_courses")
}

model Chapter {
  id           Int      @id @default(autoincrement())
  name         String
  description  String
  level        Int
  courseId     Int
  isCheckpoint Int      @default(0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relasi
  course       Course        @relation(fields: [courseId], references: [id], onDelete: Cascade)
  materials    Material[]
  assessments  Assessment[]
  assignments  Assignment[]
  userProgress UserChapter[]
  badges       Badge[]

  @@index([courseId])
  @@map("chapters")
}

model Material {
  id        Int      @id @default(autoincrement())
  chapterId Int
  name      String
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relasi
  chapter Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@index([chapterId])
  @@map("materials")
}

model Assessment {
  id          Int      @id @default(autoincrement())
  chapterId   Int
  instruction String   @db.Text
  questions   Json?
  answers     Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relasi
  chapter Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@index([chapterId])
  @@map("assessments")
}

model Assignment {
  id          Int      @id @default(autoincrement())
  chapterId   Int
  instruction String   @db.Text
  fileUrl     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relasi
  chapter Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@index([chapterId])
  @@map("assignments")
}

model UserChapter {
  id                 Int      @id @default(autoincrement())
  userId             Int
  chapterId          Int
  isStarted          Boolean  @default(false)
  isCompleted        Boolean  @default(false)
  materialDone       Boolean  @default(false)
  assessmentDone     Boolean  @default(false)
  assignmentDone     Boolean  @default(false)
  assessmentAnswer   Json?
  assessmentGrade    Int      @default(0)
  submission         String?
  timeStarted        DateTime @default(now())
  timeFinished       DateTime @default(now())
  assignmentScore    Int      @default(0)
  assignmentFeedback String   @default("")
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  // Relasi
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  chapter Chapter @relation(fields: [chapterId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([chapterId])
  @@map("user_chapters")
}

// --- MODEL GAMIFICATION (BADGES & TRADES) ---
model Badge {
  id        Int       @id @default(autoincrement())
  name      String
  type      BadgeType
  image     String?
  courseId  Int
  chapterId Int
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  // Relasi
  course     Course      @relation(fields: [courseId], references: [id], onDelete: Cascade)
  chapter    Chapter     @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  userBadges UserBadge[]

  @@unique([courseId, chapterId, type])
  @@index([courseId])
  @@index([chapterId])
  @@map("badges")
}

enum BadgeType {
  BEGINNER
  INTERMEDIATE
  ADVANCE
}

model UserBadge {
  id          Int      @id @default(autoincrement())
  userId      Int
  badgeId     Int
  isPurchased Boolean  @default(false) // Ditandai true jika sudah ditukar dengan item Trade
  awardedAt   DateTime @default(now())

  // Relasi
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge Badge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([badgeId])
  @@map("user_badges")
}

// Model Trade digunakan sebagai Master Data Avatar & Reward
// --- MODEL GAMIFICATION (BADGES & TRADES) ---

model Trade {
  id                Int           @id @default(autoincrement())
  title             String
  image             String        // URL Gambar (Bisa foto Reward atau PNG Bingkai Transparan)
  description       String        @db.Text
  
  // Penambahan Kategori untuk integrasi UI yang lebih baik
  // Contoh nilai: "AVATAR", "REWARD", "FRAME", "BOOSTER"
  category          String        @default("REWARD") 
  
  // Jika null, berarti item Marketplace murni (Shop Tab)
  // Jika diisi, berarti butuh Badge tertentu (Rewards Tab)
  requiredBadgeType BadgeType? 
  
  // Harga dalam poin untuk sistem ekonomi Players
  priceInPoints     Int           @default(0) 
  
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  // Relasi ke tabel kepemilikan user
  userTrades        UserTrade[]

  @@map("trades")
}

// Model UserTrade mencatat kepemilikan item oleh user
model UserTrade {
  id          Int      @id @default(autoincrement())
  userId      Int
  tradeId     Int
  
  // Menandai apakah item ini sedang dipakai (khusus untuk FRAME atau AVATAR)
  isEquipped  Boolean  @default(false) 
  
  purchasedAt DateTime @default(now())

  // Relasi
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  trade Trade @relation(fields: [tradeId], references: [id], onDelete: Cascade)

  @@unique([userId, tradeId]) // Mencegah user memiliki item yang sama dua kali
  @@index([userId])
  @@index([tradeId])
  @@map("user_trades")
}

// prisma/schema.prisma

model Challenge {
  id          Int           @id @default(autoincrement())
  title       String
  description String
  goal        Int
  rewardPoint Int
  type        ChallengeType // Ini merujuk ke enum di bawah
  createdAt   DateTime      @default(now())

  @@map("challenges")
}

// WAJIB ADA: Definisi tipe tantangan
enum ChallengeType {
  DAILY_LOGIN
  COMPLETE_CHAPTER
  FINISH_ASSESSMENT
}

model UserChallenge {
  id              Int      @id @default(autoincrement())
  userId          Int
  challengeId     Int
  currentProgress Int      @default(0)
  isCompleted     Boolean  @default(false)
  isClaimed       Boolean  @default(false)
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, challengeId])
  @@map("user_challenges")
}

model UserActivityLog {
  id        Int      @id @default(autoincrement())
  userId    Int
  type      String // QUIZ_SCORE, COMPLETION, EXPLORATION, SESSION, ACCESS, REWARD, ANOMALY
  value     Float // Nilai numerik log
  createdAt DateTime @default(now())
  metadata  Json?
  user      User     @relation(fields: [userId], references: [id])

  @@map("user_activity_logs")
  @@index([userId])
}

model UserAdaptiveProfile {
  id             Int      @id @default(autoincrement())
  userId         Int      @unique
  currentCluster String   // Achievers, Free Spirits, Players, Disruptors
  confidence     Float    // Tingkat keyakinan model (0.0 - 1.0)

  // --- KOLOM BARU: PEMETAAN INDEKS (0.0 - 1.0) ---
  // Kolom ini akan terlihat di Prisma Studio sebagai angka desimal
  achieverIndex   Float   @default(0) // Pemetaan Quiz & Progres
  freeSpiritIndex Float   @default(0) // Pemetaan Eksplorasi & Durasi
  playerIndex     Float   @default(0) // Pemetaan Akses & Reward
  disruptorIndex  Float   @default(0) // Pemetaan Anomali
  // -----------------------------------------------

  lastUpdated    DateTime @default(now()) @updatedAt
  user           User     @relation(fields: [userId], references: [id])

  @@map("user_adaptive_profiles")
  @@index([userId])
}
